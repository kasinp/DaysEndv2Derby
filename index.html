<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>Days End Derby — BMW M4</title>
<style>
  html,body{height:100%;margin:0;overflow:hidden;background:#07090f}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #scene{display:block}
  #ui{position:fixed;left:16px;top:12px;color:#e7eaee;pointer-events:none;z-index:6}
  #title{font-weight:800;letter-spacing:.06em;font-size:18px;text-shadow:0 2px 12px rgba(0,0,0,.6)}
  #hud{position:fixed;right:16px;top:16px;display:grid;gap:6px;pointer-events:none;z-index:6}
  .pill{background:rgba(10,12,20,.6);border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);padding:8px 12px;border-radius:12px;font-size:13px;color:#e7eaee}
  #help{position:fixed;left:16px;bottom:16px;max-width:520px;line-height:1.35;opacity:.9;z-index:6}
  #damageBarWrapper{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;width:min(70vw,520px);height:10px;border-radius:999px;background:rgba(255,255,255,.08);box-shadow:inset 0 2px 6px rgba(0,0,0,.25);z-index:6}
  #damageBar{height:100%;width:0%;background:linear-gradient(90deg,#4ade80,#facc15,#f59e0b,#ef4444);border-radius:inherit;transition:width .15s ease}
  #mapFrame{position:fixed;left:16px;top:52px;width:200px;height:200px;border-radius:14px;border:1px solid rgba(255,255,255,.12);box-shadow:0 10px 30px rgba(0,0,0,.45);background:rgba(8,10,18,.5);z-index:5;pointer-events:none}
  /* Start overlay (retro Miami / neon) */
  #overlay{position:fixed;inset:0;display:grid;place-items:center;background:
    radial-gradient(1200px 900px at 50% 50%,rgba(3,5,12,.4),rgba(3,5,12,.92)),
    linear-gradient(135deg,#0a0f1e 0%,#0b0720 40%,#131221 100%);
    color:#fff;transition:opacity .3s ease;z-index:7}
  #overlay.hidden{opacity:0;pointer-events:none}
  .card{position:relative;text-align:center;padding:32px 36px;border-radius:18px;border:1px solid rgba(255,255,255,.08);background:rgba(10,12,24,.54);box-shadow:0 20px 90px rgba(0,0,0,.7);cursor:pointer}
  .miamiTitle{font-size:54px;letter-spacing:.06em;margin:0 0 8px;line-height:1;font-weight:900}
  .miamiTitle .line1{display:block;font-family:cursive;font-weight:900;color:#ff69e6;text-shadow:0 0 10px rgba(255,105,230,.9),0 0 24px rgba(255,105,230,.6);transform:skewX(-6deg)}
  .miamiTitle .line2{display:block;margin-top:4px;background:linear-gradient(90deg,#3cf0ff,#73fff6,#7dfdff);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 12px rgba(75,255,240,.7)}
  .btnStart{display:inline-block;margin-top:8px;font-weight:800;cursor:pointer;background:linear-gradient(90deg,#07d1ff,#a2f6ff);color:#02121a;border:none;border-radius:12px;padding:12px 18px;box-shadow:0 10px 30px rgba(7,209,255,.35)}
  #tapHint{position:fixed;inset:auto 0 0 0;text-align:center;color:#cfe7ff;font-weight:700;padding:10px 8px;opacity:0;transition:opacity .2s;z-index:8;pointer-events:none}
  #tapHint.show{opacity:1}
  #touchControls{position:fixed;inset:auto 0 0 0;display:flex;justify-content:space-between;padding:14px;gap:12px;z-index:6}
  .tcCol{display:flex;gap:12px}
  .tcBtn{user-select:none;-webkit-user-select:none;touch-action:none;width:64px;height:64px;display:grid;place-items:center;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(8,10,18,.5);color:#d9e3ea;font-weight:900;box-shadow:0 6px 28px rgba(0,0,0,.45)}
  .tcBtn:active{transform:scale(.96)}
</style>
</head>
<body>
  <div id="ui"><div id="title">DAYS END DERBY</div></div>
  <div id="hud">
    <div class="pill" id="speed">Speed: 0 km/h</div>
    <div class="pill" id="distance">Distance: 0 m</div>
    <div class="pill" id="fps">FPS: 0</div>
  </div>
  <div id="help" class="pill">Controls: W accelerate · S brake · A left · D right · Shift nitro · R reset · Mobile: on-screen buttons</div>
  <div id="damageBarWrapper"><div id="damageBar"></div></div>
  <div id="mapFrame"></div>

  <div id="tapHint">Tap to start</div>
  <div id="overlay">
    <div class="card" id="overlayCard">
      <div class="miamiTitle"><span class="line1">Days End</span><span class="line2">DERBY</span></div>
      <div class="subtitle" id="subtitle">Endless inner-city highway sprint. Beat the AI. Avoid traffic. Survive the night.</div>
      <button class="btnStart" id="startBtn">Start Race</button>
      <button id="bigStart" style="position:absolute;inset:0;opacity:0;border:none;background:transparent"></button>
    </div>
  </div>

  <div id="touchControls">
    <div class="tcCol"><div class="tcBtn" data-key="a">◀︎</div><div class="tcBtn" data-key="d">▶︎</div></div>
    <div class="tcCol"><div class="tcBtn" data-key="s">▮▮</div><div class="tcBtn" data-key="w">▲</div><div class="tcBtn" data-key="shift">⚡</div></div>
  </div>

  <canvas id="scene"></canvas>

  <!-- Three.js r149 + GLTFLoader -->
  <script src="https://unpkg.com/three@0.149.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.149.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
(function(){
  // ---------- Boot / Renderer ----------
  var started=false;
  var canvas=document.getElementById('scene');
  var renderer=new THREE.WebGLRenderer({canvas:canvas,antialias:true,powerPreference:'high-performance'});
  var IS_IOS=/iPhone|iPad|iPod/i.test(navigator.userAgent||''); var perfMode=IS_IOS;
  function dprCap(){return perfMode?Math.min(window.devicePixelRatio||1, IS_IOS?1.2:1.5):Math.min(window.devicePixelRatio||1,2);}
  function applyShadowSetting(){renderer.shadowMap.enabled=!perfMode;}
  renderer.setPixelRatio(dprCap()); renderer.setSize(window.innerWidth,window.innerHeight,false);
  renderer.shadowMap.type=THREE.PCFSoftShadowMap; applyShadowSetting();

  // ---------- Scene / Camera ----------
  var scene=new THREE.Scene(); scene.fog=new THREE.FogExp2(0x070a12,0.018);
  var camera=new THREE.PerspectiveCamera(72,window.innerWidth/window.innerHeight,0.1,3000);
  camera.position.set(0,3.2,10.5);

  // ---------- Sky ----------
  var skyGeo=new THREE.SphereGeometry(1500,32,16);
  var skyMat=new THREE.ShaderMaterial({
    side:THREE.BackSide,
    uniforms:{top:{value:new THREE.Color(0x060914)},bottom:{value:new THREE.Color(0x0a0f1e)}},
    vertexShader:'varying vec3 vPos;void main(){vPos=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);} ',
    fragmentShader:'varying vec3 vPos;uniform vec3 top;uniform vec3 bottom;void main(){float h=normalize(vPos).y*0.5+0.5;gl_FragColor=vec4(mix(bottom,top,h),1.0);} '
  });
  var sky=new THREE.Mesh(skyGeo,skyMat); scene.add(sky);

  // ---------- North Star (image + glow) ----------
  var starTex=new THREE.TextureLoader().load('assets/north_star.png');
  var star=new THREE.Sprite(new THREE.SpriteMaterial({map:starTex,transparent:true,opacity:1.0}));
  star.position.set(-80,120,-300); star.scale.set(120,120,1); scene.add(star);
  var starGlow=new THREE.Sprite(new THREE.SpriteMaterial({
    map:starTex,color:0x9bd0ff,transparent:true,opacity:0.35,depthWrite:false,blending:THREE.AdditiveBlending
  }));
  starGlow.position.copy(star.position); starGlow.scale.set(220,220,1); scene.add(starGlow);

  // ---------- Lights ----------
  var hemi=new THREE.HemisphereLight(0x9bd0ff,0x0a0d14,0.85); scene.add(hemi);
  var dir=new THREE.DirectionalLight(0xffffff,1.25); dir.position.set(-30,60,10); dir.castShadow=true;
  dir.shadow.mapSize.set(2048,2048); dir.shadow.camera.near=1; dir.shadow.camera.far=400;
  dir.shadow.camera.left=-80; dir.shadow.camera.right=80; dir.shadow.camera.top=80; dir.shadow.camera.bottom=-80; scene.add(dir);

  // ---------- Procedural textures ----------
  function noise(ctx,w,h,n,a){for(var i=0;i<n;i++){ctx.fillStyle='rgba(255,255,255,'+((Math.random()*0.5+0.2)*a)+')';ctx.fillRect(Math.random()*w,Math.random()*h,1,1);}}
  function texRoad(){var c=document.createElement('canvas');c.width=c.height=1024;var g=c.getContext('2d');
    g.fillStyle='#202430';g.fillRect(0,0,1024,1024);noise(g,1024,1024,5000,0.018);
    g.strokeStyle='#e6e9f0';g.lineWidth=8;g.setLineDash([40,36]);g.beginPath();g.moveTo(512,0);g.lineTo(512,1024);g.stroke();
    g.setLineDash([]);g.strokeStyle='#b9becc';g.lineWidth=6;g.beginPath();g.moveTo(220,0);g.lineTo(220,1024);g.stroke();g.beginPath();g.moveTo(804,0);g.lineTo(804,1024);g.stroke();
    var t=new THREE.CanvasTexture(c);t.wrapS=t.wrapT=THREE.RepeatWrapping;t.repeat.set(1,60);t.anisotropy=8;return t;}
  function texFacade(){var c=document.createElement('canvas');c.width=c.height=512;var g=c.getContext('2d');
    g.fillStyle='#1b2030';g.fillRect(0,0,512,512);
    for(var y=40;y<480;y+=28){for(var x=32;x<480;x+=24){var on=Math.random()>0.55;g.fillStyle=on?'hsl('+(40+Math.random()*10)+',90%,'+(62+Math.random()*18)+'%)':'#0c111e';g.fillRect(x,y,14,10);}}
    for(var i=0;i<6;i++){var dx=20+i*80;g.fillStyle='#17202b';g.fillRect(dx,440,30,40);g.fillStyle='#0d7aff';g.fillRect(dx+12,454,6,12);}
    var t=new THREE.CanvasTexture(c);t.wrapS=t.wrapT=THREE.RepeatWrapping;t.repeat.set(1,2);t.anisotropy=8;return t;}
  function texLeaves(){var c=document.createElement('canvas');c.width=c.height=128;var g=c.getContext('2d');
    g.fillStyle='#18301b';g.fillRect(0,0,128,128);
    for(var i=0;i<500;i++){g.fillStyle='rgba('+(60+Math.random()*50)+','+(120+Math.random()*80)+','+(60+Math.random()*50)+','+(0.15+Math.random()*0.25)+')';g.beginPath();g.arc(Math.random()*128,Math.random()*128,Math.random()*2+0.5,0,Math.PI*2);g.fill();}
    var t=new THREE.CanvasTexture(c);t.wrapS=t.wrapT=THREE.RepeatWrapping;t.anisotropy=8;return t;}
  var roadTex=texRoad(), facadeTex=texFacade(), leafTex=texLeaves();

  // ---------- Highway ----------
  var roadWidth=14, laneHalf=roadWidth/2-1.5, segLen=60, segCount=(IS_IOS?16:24);
  var highway=new THREE.Group(); scene.add(highway);
  var roadMat=new THREE.MeshStandardMaterial({map:roadTex,roughness:.96,metalness:0});
  var borderMat=new THREE.MeshStandardMaterial({color:0x2b3242,roughness:1});
  var segments=[];
  for(var si=0;si<segCount;si++){
    var g=new THREE.Group();
    var plane=new THREE.Mesh(new THREE.PlaneGeometry(roadWidth,segLen),roadMat);plane.rotation.x=-Math.PI/2;plane.receiveShadow=true;g.add(plane);
    var curbGeo=new THREE.BoxGeometry(.4,.2,segLen);
    var left=new THREE.Mesh(curbGeo,borderMat);left.position.set(-roadWidth/2-.2,.1,0);left.receiveShadow=true;g.add(left);
    var right=left.clone();right.position.x*=-1;g.add(right);
    g.position.z=-si*segLen; highway.add(g); segments.push(g);
    // street lights
    var poleMat=new THREE.MeshStandardMaterial({color:0x3a4354,metalness:.2,roughness:.9});
    var lampMat=new THREE.MeshStandardMaterial({color:0xf2fbff,emissive:0xbfe8ff,emissiveIntensity:2.2,roughness:.3});
    var poleGeo=new THREE.CylinderGeometry(0.06,0.06,4.5,8), headGeo=new THREE.BoxGeometry(0.30,0.18,0.60);
    function addLamp(s){var pole=new THREE.Mesh(poleGeo,poleMat);pole.position.set(s*(roadWidth/2+1.2),2.25,0);g.add(pole);
      var head=new THREE.Mesh(headGeo,lampMat);head.position.set(pole.position.x,4.5,-segLen*0.35);g.add(head);
      var light=new THREE.PointLight(0xbfe8ff,0.8,16,2.0);light.position.set(head.position.x,4.4,head.position.z);g.add(light);}
    if(!perfMode||(si%2===0)){addLamp(-1);addLamp(1);}
  }

  // ---------- City ----------
  var city=new THREE.Group(); scene.add(city);
  var buildingMatStd=new THREE.MeshStandardMaterial({map:facadeTex,emissive:0xffffff,emissiveIntensity:.25,roughness:.96,metalness:.08});
  var buildingMatBasic=new THREE.MeshBasicMaterial({map:facadeTex});
  var buildingMat=perfMode?buildingMatBasic:buildingMatStd;

  function makeTree(){var t=new THREE.Group();
    var trunk=new THREE.Mesh(new THREE.CylinderGeometry(0.12,0.18,1.2,8),new THREE.MeshStandardMaterial({color:0x6b4f2a,roughness:1}));trunk.position.y=.6;t.add(trunk);
    var crown=new THREE.Mesh(new THREE.SphereGeometry(0.8,12,10),new THREE.MeshStandardMaterial({map:leafTex,roughness:1}));crown.position.y=1.5;t.add(crown);
    return t;}

  function spawnBuildingRow(z){
    var sideOffset=roadWidth/2+2.5;
    for(var s=-1;s<=1;s+=2){
      var count=6;
      for(var i=0;i<count;i++){
        var w=3+Math.random()*3, d=3+Math.random()*3, h=14+Math.random()*52;
        var x=s*(sideOffset+i*(4+Math.random()*2)+Math.random()*1.5);
        var mesh=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),buildingMat);
        mesh.position.set(x,h/2,z - i*6 - Math.random()*3);
        mesh.castShadow=mesh.receiveShadow=true; city.add(mesh);
        if(Math.random()>0.4){ var planter=new THREE.Mesh(new THREE.BoxGeometry(1.2,0.4,1.2), new THREE.MeshStandardMaterial({color:0x242a36,roughness:1}));
          planter.position.set(x+(Math.random()-.5)*2,0.2,mesh.position.z+(Math.random()-.5)*2); city.add(planter);
          var tree=makeTree(); tree.position.set(planter.position.x,0,planter.position.z); city.add(tree); }
      }
    }
  }
  for(var k=0;k<90;k++) spawnBuildingRow(-k*12 - 30);

  // Endless skyline recycle
  var citySpan=90*12+300;
  function recycleCityAhead(){ for(var i=0;i<city.children.length;i++){ var o=city.children[i]; if(!o||!o.position) continue; if(o.position.z + city.position.z > 40){ o.position.z -= citySpan; } } }

  // ---------- Player (BMW M4, external GLB) ----------
  var player=new THREE.Group(); player.userData.wheels=[]; scene.add(player); player.position.set(0,0,2);

  (function loadM4(){
    if(!THREE.GLTFLoader){ console.error('GLTFLoader missing'); return; }
    var loader=new THREE.GLTFLoader();
    loader.load('assets/bmw_m4.glb', function(gltf){
      var car=gltf.scene||(gltf.scenes&&gltf.scenes[0]); if(!car){ console.error('No scene in GLB'); return; }
      car.scale.setScalar(0.9); car.rotation.y=Math.PI; car.position.copy(player.position);
      car.traverse(function(o){ if(o.isMesh){ o.castShadow=o.receiveShadow=true; } });
      scene.add(car); scene.remove(player); player=car;

      // Detect wheels by name/position
      var wheels={FL:null,FR:null,RL:null,RR:null};
      player.traverse(function(o){
        if(!o.isMesh) return; var n=(o.name||'').toLowerCase();
        if(n.includes('wheel')||n.includes('rim')||n.includes('tyre')||n.includes('tire')){
          if(o.position.z<0 && o.position.x<0 && !wheels.FL) wheels.FL=o;
          else if(o.position.z<0 && o.position.x>0 && !wheels.FR) wheels.FR=o;
          else if(o.position.z>=0 && o.position.x<0 && !wheels.RL) wheels.RL=o;
          else if(o.position.z>=0 && o.position.x>0 && !wheels.RR) wheels.RR=o;
        }
      });
      var arr=[wheels.FL,wheels.FR,wheels.RL,wheels.RR].filter(Boolean);
      player.userData.wheels=arr;

      // Auto-detect spin axis per wheel (choose axis most aligned with world X)
      player.userData.spinAxes=[];
      var temp=new THREE.Matrix3(), wx=new THREE.Vector3(1,0,0);
      for(var i=0;i<arr.length;i++){
        var w=arr[i]; temp.setFromMatrix4(w.matrixWorld);
        var lx=new THREE.Vector3(1,0,0).applyMatrix3(temp).normalize();
        var ly=new THREE.Vector3(0,1,0).applyMatrix3(temp).normalize();
        var lz=new THREE.Vector3(0,0,1).applyMatrix3(temp).normalize();
        var dots=[Math.abs(lx.dot(wx)), Math.abs(ly.dot(wx)), Math.abs(lz.dot(wx))];
        var idx=0,best=dots[0]; if(dots[1]>best){idx=1;best=dots[1];} if(dots[2]>best){idx=2;}
        player.userData.spinAxes[i]=(idx===0?'x':(idx===1?'y':'z'));
      }

      // Exhaust ref for nitro FX anchor
      var exhaust=new THREE.Object3D(); exhaust.position.set(0,0.42,2.0); player.add(exhaust); player.userData.exhaust=exhaust;
      console.log('BMW M4 loaded. spinAxes:', player.userData.spinAxes);
    }, undefined, function(err){ console.error('GLB load error', err); });
  })();

  // ---------- Input ----------
  var keys={w:false,a:false,s:false,d:false,shift:false};
  function setKey(k,v){ if(keys.hasOwnProperty(k)){ keys[k]=v; if(!started&&v) startGame(); } }
  window.addEventListener('keydown',e=>{ setKey(e.key.toLowerCase(),true); if(e.key==='r') resetGame(); });
  window.addEventListener('keyup',e=>{ if(keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key.toLowerCase()]=false; });
  document.querySelectorAll('.tcBtn').forEach(el=>{
    var k=el.getAttribute('data-key'); const on=v=>setKey(k,v); const off=()=>on(false);
    el.addEventListener('pointerdown',e=>{e.preventDefault();on(true);});
    el.addEventListener('pointerup',off); el.addEventListener('pointerleave',off); el.addEventListener('pointercancel',off);
  });

  // ---------- Overlay / Start (iPhone safe) ----------
  var overlay=document.getElementById('overlay'), startBtn=document.getElementById('startBtn'), overlayCard=document.getElementById('overlayCard'), bigStart=document.getElementById('bigStart'), tapHint=document.getElementById('tapHint');
  if(/iPhone|iPad|iPod/i.test(navigator.userAgent)) tapHint.classList.add('show');
  function hideTapHint(){ tapHint.classList.remove('show'); }
  function hideOverlay(){ overlay.classList.add('hidden'); }
  function startGame(){ hideOverlay(); hideTapHint(); started=true; }
  function resetGame(){ speed=0; _lat=0; distance=0; nitro=100; damage=0; _shake=0; if(player){ player.position.set(0,0,2);} highway.position.z=0; city.position.z=0; aiCars.concat(traffic).forEach((c,i)=>{c.position.z=-60-i*30-Math.random()*80; c.position.x=(Math.floor(Math.random()*3)-1)*(14/4.2);}); started=true; }
  [startBtn,overlay,overlayCard,bigStart,canvas,document].forEach(el=>{ if(!el) return; ['touchstart','pointerdown','mousedown'].forEach(evt=>el.addEventListener(evt,(e)=>{ e.preventDefault?.(); if(!started) startGame(); },{passive:false,once:true})); });

  // ---------- HUD / Minimap ----------
  function updateHUD(){ document.getElementById('speed').textContent='Speed: '+Math.round(_spd_kmh||0)+' km/h'; document.getElementById('distance').textContent='Distance: '+Math.round(distance)+' m'; document.getElementById('damageBar').style.width=(damage)+'%'; }
  var mapCam=new THREE.OrthographicCamera(-20,20,20,-20,0.1,200); mapCam.position.set(0,60,0); mapCam.lookAt(0,0,-10); mapCam.layers.enable(1);

  // ---------- Gameplay state ----------
  var speed=0, distance=0, nitro=100, damage=0;
  var _lat=0, _shake=0, _spd_kmh=0;
  var steer=0, accelSm=0;

  // ---------- AI + Traffic ----------
  function makeBoxCar(color){ var g=new THREE.Group(); var m=new THREE.MeshStandardMaterial({color:color||0x22d3ee,metalness:.3,roughness:.6}); var b=new THREE.Mesh(new THREE.BoxGeometry(1.8,.6,3.2),m); b.position.y=.5; g.add(b); return g; }
  var aiCars=[]; function spawnAICar(z){ var c=makeBoxCar([0xf43f5e,0x22c55e,0xf59e0b,0x60a5fa,0xa78bfa,0x14b8a6,0x9ca3af][Math.floor(Math.random()*7)]); c.position.set((Math.floor(Math.random()*3)-1)*(14/4.2),0,(z||-60)-Math.random()*80); c.userData.speed=26+Math.random()*20; aiCars.push(c); scene.add(c); }
  for(var iA=0;iA<12;iA++) spawnAICar(-30-iA*30);
  var traffic=[]; var trafficTimer=0; function spawnTraffic(ahead){ var c=makeBoxCar(0x808b98); c.position.set((Math.floor(Math.random()*3)-1)*(14/4.2),0,(player.position?player.position.z:0) - (ahead||200) - Math.random()*200); c.userData.speed=10+Math.random()*20; traffic.push(c); scene.add(c); }

  // ---------- Animate ----------
  var roadTex=roadTex, last=performance.now(), fpsAcc=0, fpsCount=0;
  function tick(now){
    var dt=Math.min(0.05,(now-last)/1000); last=now;

    if(started){
      // spawn traffic
      trafficTimer-=dt; if(trafficTimer<=0){ spawnTraffic(250+Math.random()*250); trafficTimer=0.8+Math.random()*1.2; }

      // nitro
      var nitroOn=(keys.shift&&nitro>0);
      var targetMax=(nitroOn?205:185)/3.6;
      var effAccel=10.5/3.6*(nitroOn?1.5:1.0);
      if(keys.w) speed+=effAccel*dt; else speed-= (9/3.6*0.45)*dt;
      if(keys.s) speed-=16/3.6*dt;
      if(nitroOn){nitro=Math.max(0,nitro-18*dt);} else {nitro=Math.min(100,nitro+7*dt);}
      if(speed<0) speed=0; if(speed>targetMax) speed=targetMax;
      _spd_kmh=speed*3.6;

      // steering & body motion
      var steerInput=(keys.d?1:0)-(keys.a?1:0);
      var speedNorm=THREE.MathUtils.clamp((_spd_kmh||0)/185,0,1);
      var steerDamp=THREE.MathUtils.lerp(1.0,0.65,speedNorm);
      steer+=((steerInput*steerDamp)-steer)*Math.min(1,10*dt);

      var latAccel=steer*6.5; _lat+= (latAccel-_lat)*Math.min(1,6*dt);
      if(player) player.position.x=Math.max(-laneHalf,Math.min(laneHalf, (player.position.x||0)+_lat*dt));

      var accNow=((keys.w?1:0)-(keys.s?1:0))*(nitroOn?1.5:1.0); accelSm+=(accNow-accelSm)*Math.min(1,6*dt);
      if(player){ player.rotation.z += (-(steer)*0.06 - player.rotation.z)*Math.min(1,8*dt);
                  player.rotation.x += ((-accelSm)*0.035 - player.rotation.x)*Math.min(1,8*dt); }

      // forward scroll
      var dz=speed*dt; distance+=dz*10;
      highway.position.z+=dz; city.position.z+=dz*.9; recycleCityAhead();

      // wheel steer + spin
      if(player && player.userData && player.userData.wheels){
        var ws=player.userData.wheels; var steerAngle=THREE.MathUtils.clamp(steer,-1,1)*0.4;
        if(ws[0]) ws[0].rotation.y=steerAngle; if(ws[1]) ws[1].rotation.y=steerAngle;
        var axes=player.userData.spinAxes||[];
        for(var wi=0; wi<ws.length; wi++){
          var ax=axes[wi]||'x'; var w=ws[wi];
          if(ax==='x') w.rotation.x -= dz*2;
          else if(ax==='y') w.rotation.y -= dz*2;
          else w.rotation.z -= dz*2;
        }
      }

      // AI & traffic move
      for(var i=0;i<aiCars.length;i++){ var c=aiCars[i], sp=(c.userData.speed||30)/3.6; c.position.z+=dz-sp*dt;
        if(c.position.z-highway.position.z>20){ c.position.z=-(120+Math.random()*100); c.position.x=(Math.floor(Math.random()*3)-1)*(14/4.2); }
        var dx=player.position.x-c.position.x; if(Math.abs(c.position.z-player.position.z)<18 && Math.abs(dx)<2){ c.position.x += (dx>0?-1:1)*dt*4.5; c.position.x=Math.max(-laneHalf,Math.min(laneHalf,c.position.x)); }
      }
      for(var t=0;t<traffic.length;t++){ var c2=traffic[t], sp2=(c2.userData.speed||20)/3.6; c2.position.z+=dz-sp2*dt;
        if(c2.position.z-highway.position.z>30){ c2.position.z=-(200+Math.random()*200); c2.position.x=(Math.floor(Math.random()*3)-1)*(14/4.2); } }

      // collisions
      function collide(list){ for(var j=0;j<list.length;j++){ var oc=list[j]; var dx=player.position.x-oc.position.x, dz2=(player.position.z-oc.position.z); var d2=dx*dx+dz2*dz2; if(d2<(1.8*1.8)){ damage=Math.min(100,damage+22); speed*=0.45; oc.position.z-=2; oc.position.x+=(Math.random()<.5?-1:1)*.6; } } }
      collide(aiCars); collide(traffic);
      if(Math.abs(player.position.x)>=laneHalf-0.05) damage=Math.min(100,damage+10*dt);

      // camera follow & mild speed FOV boost
      var baseTarget=new THREE.Vector3(player.position.x*0.6,3.2,10.5-(keys.w?0.6:0));
      camera.position.lerp(baseTarget, 1 - Math.pow(0.001, dt));
      var fovBoost=((keys.shift&&nitro>0)?4:2)*Math.min(1,(_spd_kmh||0)/140); camera.fov=72+fovBoost; camera.updateProjectionMatrix();

      updateHUD();
      if(damage>=100){ overlay.classList.remove('hidden'); document.querySelector('.miamiTitle .line1').textContent='Crashed!'; document.querySelector('.miamiTitle .line2').textContent='TRY AGAIN'; document.getElementById('subtitle').textContent='Press R to reset and race again.'; started=false; }
    }

    // render main view
    renderer.setViewport(0,0,window.innerWidth,window.innerHeight);
    renderer.setScissorTest(false); renderer.render(scene,camera);

    // render minimap
    var mapSize=Math.min(220, Math.min(window.innerWidth,window.innerHeight)/3);
    var mx=24, my=60; var mapCam=new THREE.OrthographicCamera(-20,20,20,-20,0.1,200);
    mapCam.position.set(player.position.x,60,player.position.z+5); mapCam.lookAt(player.position.x,0,player.position.z-20);
    renderer.setScissorTest(true);
    renderer.setScissor(mx, window.innerHeight-(my+mapSize), mapSize, mapSize);
    renderer.setViewport(mx, window.innerHeight-(my+mapSize), mapSize, mapSize);
    renderer.render(scene,mapCam);
    renderer.setScissorTest(false);

    // FPS
    fpsAcc+=dt; fpsCount++; if(fpsAcc>0.5){ document.getElementById('fps').textContent='FPS: '+Math.round(fpsCount/fpsAcc); fpsAcc=0; fpsCount=0; }

    requestAnimationFrame(tick);
  }
  var fpsAcc=0,fpsCount=0; requestAnimationFrame(function t(n){ tick(n); });

  // ---------- Resize ----------
  function hardResize(){ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setPixelRatio(dprCap()); renderer.setSize(window.innerWidth,window.innerHeight,false); }
  window.addEventListener('resize', hardResize);
  window.addEventListener('orientationchange', ()=>setTimeout(hardResize,200));
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(hardResize,100); });

})();
</script>
</body>
</html>
